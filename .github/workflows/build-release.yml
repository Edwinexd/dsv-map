name: Build and Upload

on:
  push:
    branches:
      - master
  schedule:
    # Full build: daily at 2:00 AM UTC (3:00 AM Stockholm winter, 4:00 AM Stockholm summer)
    - cron: '0 2 * * *'
    # Day/night swap checks throughout the day (every 2 hours)
    # These only swap between pre-built day/night versions based on Stockholm time
    - cron: '0 4,6,8,10,12,14,16,18,20,22 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  # Determine if this is a full build or just a swap
  check-run-type:
    runs-on: ubuntu-latest
    outputs:
      run_type: ${{ steps.determine.outputs.run_type }}
    steps:
      - name: Determine run type
        id: determine
        run: |
          # Full build at 2 AM UTC, on push, or manual trigger
          HOUR=$(date -u +%H)
          if [[ "${{ github.event_name }}" == "push" ]] || \
             [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || \
             [[ "$HOUR" == "02" ]]; then
            echo "run_type=full" >> $GITHUB_OUTPUT
            echo "Run type: full build"
          else
            echo "run_type=swap" >> $GITHUB_OUTPUT
            echo "Run type: swap only"
          fi

  # Full build job
  build-and-upload:
    needs: check-run-type
    if: needs.check-run-type.outputs.run_type == 'full'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure credentials
        env:
          SU_USERNAME: ${{ secrets.SU_USERNAME }}
          SU_PASSWORD: ${{ secrets.SU_PASSWORD }}
        run: |
          cat > .env << EOF
          SU_USERNAME=$SU_USERNAME
          SU_PASSWORD=$SU_PASSWORD
          EOF

      - name: Check for display override
        id: check_override
        run: |
          if python3 ci_slide_manager.py check; then
            echo "has_override=true" >> $GITHUB_OUTPUT
          else
            echo "has_override=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload override image
        if: steps.check_override.outputs.has_override == 'true'
        run: python3 ci_slide_manager.py override

      - name: Show CI progress on display
        if: steps.check_override.outputs.has_override != 'true'
        run: python3 ci_slide_manager.py start

      - name: Run build process
        if: steps.check_override.outputs.has_override != 'true'
        id: build
        run: python3 main.py

      - name: Upload to ACT Lab display
        if: steps.check_override.outputs.has_override != 'true' && success()
        run: python3 ci_slide_manager.py success

      - name: Restore previous slide on failure
        if: steps.check_override.outputs.has_override != 'true' && failure()
        run: python3 ci_slide_manager.py failure

      - name: List generated files
        if: success()
        run: |
          echo "Generated files:"
          find output -type f

      - name: Upload build artifacts
        if: steps.check_override.outputs.has_override != 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: tv-images
          path: output/tv/
          retention-days: 7

  # Swap job - only switches between day/night versions
  swap-day-night:
    needs: check-run-type
    if: needs.check-run-type.outputs.run_type == 'swap'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure credentials
        env:
          SU_USERNAME: ${{ secrets.SU_USERNAME }}
          SU_PASSWORD: ${{ secrets.SU_PASSWORD }}
        run: |
          cat > .env << EOF
          SU_USERNAME=$SU_USERNAME
          SU_PASSWORD=$SU_PASSWORD
          EOF

      - name: Check for display override
        id: check_override
        run: |
          if python3 ci_slide_manager.py check; then
            echo "has_override=true" >> $GITHUB_OUTPUT
          else
            echo "has_override=false" >> $GITHUB_OUTPUT
          fi

      - name: Download latest build artifacts
        if: steps.check_override.outputs.has_override != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: tv-images
          path: output/tv/
          workflow: build-release.yml
          workflow_conclusion: success
          if_no_artifact_found: warn

      - name: Swap to correct day/night version
        if: steps.check_override.outputs.has_override != 'true'
        run: python3 ci_slide_manager.py swap

      - name: Upload build artifacts
        if: steps.check_override.outputs.has_override != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tv-images
          path: output/tv/
          retention-days: 7
          if-no-files-found: ignore
