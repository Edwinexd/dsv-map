name: Build and Upload

on:
  push:
    branches:
      - master
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure credentials
        env:
          SU_USERNAME: ${{ secrets.SU_USERNAME }}
          SU_PASSWORD: ${{ secrets.SU_PASSWORD }}
        run: |
          cat > .env << EOF
          SU_USERNAME=$SU_USERNAME
          SU_PASSWORD=$SU_PASSWORD
          EOF

      - name: Check for display override
        id: check_override
        run: |
          if python3 ci_slide_manager.py check; then
            echo "has_override=true" >> $GITHUB_OUTPUT
          else
            echo "has_override=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload override image
        if: steps.check_override.outputs.has_override == 'true'
        run: python3 ci_slide_manager.py override

      - name: Show CI progress on display
        if: steps.check_override.outputs.has_override != 'true'
        run: python3 ci_slide_manager.py start

      - name: Run build process
        if: steps.check_override.outputs.has_override != 'true'
        id: build
        run: python3 main.py

      - name: Clean up CI progress indicator
        if: steps.check_override.outputs.has_override != 'true' && success()
        run: python3 ci_slide_manager.py success

      - name: Upload correct day/night version
        if: steps.check_override.outputs.has_override != 'true' && success()
        run: python3 ci_slide_manager.py swap

      - name: Restore previous slide on failure
        if: steps.check_override.outputs.has_override != 'true' && failure()
        run: python3 ci_slide_manager.py failure

      - name: List generated files
        if: success()
        run: |
          echo "Generated files:"
          find output -type f

      - name: Upload build artifacts
        if: steps.check_override.outputs.has_override != 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: tv-images
          path: output/tv/
          retention-days: 7
