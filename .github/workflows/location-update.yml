name: Process Location Update

on:
  issues:
    types: [opened]

jobs:
  process-location-update:
    if: contains(github.event.issue.labels.*.name, 'location-update')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            console.log('Issue body:', issueBody);

            // Parse the issue form data
            const personIdMatch = issueBody.match(/### Person ID\s*\n\s*([^\n]+)/);
            const roomMatch = issueBody.match(/### Room Number\s*\n\s*([^\n]+)/);
            const profileUrlMatch = issueBody.match(/### Daisy Profile URL\s*\n\s*([^\n]+)/);

            const personId = personIdMatch ? personIdMatch[1].trim() : null;
            const room = roomMatch ? roomMatch[1].trim() : null;
            const profileUrl = profileUrlMatch ? profileUrlMatch[1].trim() : null;

            console.log('Parsed - Person ID:', personId);
            console.log('Parsed - Room:', room);
            console.log('Parsed - Profile URL:', profileUrl);

            // Validate the data
            const errors = [];

            // Check if all required fields are present
            if (!personId || personId === '_No response_' || personId === '') {
              errors.push('Person ID is required');
            } else if (!/^\d+$/.test(personId)) {
              errors.push('Person ID must be numeric (e.g., 175766)');
            }

            if (!room || room === '_No response_' || room === '') {
              errors.push('Room Number is required');
            } else {
              // Validate room format: either "digits" or "digit:X" or "digit:digit"
              if (!/^(\d{5}|\d:\w+)$/.test(room)) {
                errors.push('Room Number must be either a 5-digit room number (e.g., 61302) or zone notation (e.g., 2:X)');
              }
            }

            if (!profileUrl || profileUrl === '_No response_' || profileUrl === '') {
              errors.push('Daisy Profile URL is required');
            } else if (!profileUrl.includes('daisy.dsv.su.se')) {
              errors.push('Profile URL must be a valid Daisy URL');
            } else {
              // Extract person ID from URL and verify it matches
              const urlIdMatch = profileUrl.match(/personID=(\d+)/);
              if (urlIdMatch) {
                const urlPersonId = urlIdMatch[1];
                if (personId && urlPersonId !== personId) {
                  errors.push(`Person ID mismatch: form shows ${personId} but URL shows ${urlPersonId}`);
                }
              } else {
                errors.push('Could not extract person ID from profile URL');
              }
            }

            // Set outputs
            core.setOutput('valid', errors.length === 0);
            core.setOutput('person_id', personId || '');
            core.setOutput('room', room || '');
            core.setOutput('profile_url', profileUrl || '');
            core.setOutput('errors', errors.join('\n- '));

            return {
              valid: errors.length === 0,
              personId,
              room,
              profileUrl,
              errors
            };

      - name: Close invalid issue
        if: steps.parse.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const errors = `${{ steps.parse.outputs.errors }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ **Invalid submission**\n\nThe following errors were found:\n- ${errors}\n\nPlease create a new issue with valid information.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'not_planned'
            });

      - name: Update location_overrides.json
        if: steps.parse.outputs.valid == 'true'
        run: |
          PERSON_ID="${{ steps.parse.outputs.person_id }}"
          ROOM="${{ steps.parse.outputs.room }}"

          # Read and update the JSON file
          jq --arg pid "$PERSON_ID" --arg room "$ROOM" \
            '.[$pid] = $room' \
            data/location_overrides.json > temp.json && mv temp.json data/location_overrides.json

      - name: Create Pull Request
        if: steps.parse.outputs.valid == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Update location for person ID ${{ steps.parse.outputs.person_id }} to ${{ steps.parse.outputs.room }}
          branch: location-update-${{ steps.parse.outputs.person_id }}-${{ github.run_number }}
          delete-branch: true
          title: 'Location Update: Person ID ${{ steps.parse.outputs.person_id }} → ${{ steps.parse.outputs.room }}'
          body: |
            ## Location Update Request

            **Person ID:** ${{ steps.parse.outputs.person_id }}
            **New Room:** ${{ steps.parse.outputs.room }}

            Automatically generated from issue #${{ github.event.issue.number }}

            ### Changes
            - Updated `data/location_overrides.json` to set room location for person ID ${{ steps.parse.outputs.person_id }}

            Closes #${{ github.event.issue.number }}

      - name: Comment on issue
        if: steps.parse.outputs.valid == 'true' && steps.cpr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Location update request processed!**\n\nA pull request has been created: #${{ steps.cpr.outputs.pull-request-number }}\n\nOnce merged, the location will be updated to **${{ steps.parse.outputs.room }}** on the next map regeneration.`
            });
